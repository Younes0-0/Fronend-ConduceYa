---
import Layout   from '@layouts/Layout.astro';
import Menu     from '@components/layout/Menu.astro';
import Footer   from '@components/layout/Footer.astro';
import { authFetch } from '@/utils/authFetch';

const existingToken = Astro.cookies.get('jwt_token')?.value;
if (!existingToken) {
  return Astro.redirect('/login');
}


interface Alumno {
  id: number;
  usuario: {
    id: number;
    username: string;
    first_name: string;
    last_name: string;
    rol: 'A' | 'P' | 'AD';
  };
}

let usuarios: Alumno[] = [];
let nextPage: number | null = null;

try {
  const url  = new URL(Astro.request.url);
  const page = Number(url.searchParams.get('page') || 1);

  const API    = import.meta.env.PUBLIC_API_BASE ?? 'https://backend-conduceya.onrender.com';
  const apiUrl = `${API}/api/v1/alumnos/?page=${page}`;

  const data   = await authFetch<{ results: Alumno[]; next: string | null }>(Astro, apiUrl);

  if (data) {
    usuarios  = data.results;
    nextPage  = data.next ? Number(new URL(data.next).searchParams.get('page')) : null;
  }

} catch (e) {
  const err = e as Error;
  if (['NO_TOKEN', 'UNAUTHORIZED'].includes(err.message)) return Astro.redirect('/login');
  console.error(err);
}
---

<Layout title="Gestión de Usuarios">
  <Menu imageSrc="/img/logo-letras.png" imageAlt="logo de la empresa" />

  <main class="container py-4">
    <h1 class="mb-4 text-primary fw-bold">Gestión de Usuarios</h1>
    <p class="mb-3 text-secondary">Aquí puedes ver, crear, editar o eliminar alumnos y usuarios del sistema.</p>

    <div class="table-responsive">
      <table class="table table-hover align-middle bg-white rounded-4 shadow-sm">
        <thead class="table-light">
          <tr>
            <th>ID</th><th>Usuario</th><th>Nombre</th><th>Apellidos</th><th>Rol</th><th>Acciones</th>
          </tr>
        </thead>

        <tbody>
          {usuarios.map((alumno ) => (
            <tr>
              <td>{alumno.usuario.id}</td>
              <td>{alumno.usuario.username}</td>
              <td>{alumno.usuario.first_name}</td>
              <td>{alumno.usuario.last_name}</td>
              <td>
                <span class={`badge ${
                  alumno.usuario.rol === 'AD' ? 'bg-warning text-dark'
                  : alumno.usuario.rol === 'P' ? 'bg-info text-dark'
                  : 'bg-primary'
                }`}>
                  {alumno.usuario.rol === 'AD' ? 'Admin'
                  : alumno.usuario.rol === 'P' ? 'Profesor' : 'Alumno'}
                </span>
              </td>

              <td>
                <a target="_blank"
                   href={`https://backend-conduceya.onrender.com/admin/usuarios/alumno/${alumno.id}/change/`}
                   class="btn btn-sm btn-outline-primary me-2">Ver</a>

                <a target="_blank"
                   href={`https://backend-conduceya.onrender.com/admin/usuarios/alumno/${alumno.id}/change/`}
                   class="btn btn-sm btn-outline-secondary me-2">Editar</a>

                <a target="_blank"
                   href={`https://backend-conduceya.onrender.com/admin/usuarios/alumno/${alumno.id}/delete/`}
                   class="btn btn-sm btn-outline-danger">Eliminar</a>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-center gap-3 my-4">
      {nextPage &&
        <a href={`?page=${nextPage}`} class="btn btn-outline-primary btn-lg">
          Mostrar más usuarios
        </a>}
      <a href="https://backend-conduceya.onrender.com/admin/usuarios/user/add/?_to_field=id&_popup=1" class="btn btn-primary btn-lg">
        Añadir Usuario
      </a>
    </div>
  </main>

  <Footer />
</Layout>
